<!DOCTYPE HTML>
<html>
<head>
  <link rel="stylesheet" href="bower_components/webix/codebase/webix.css" type="text/css">
  <script src="bower_components/webix/codebase/webix.js" type="text/javascript"></script>
  <script src="bower_components/jquery/dist/jquery.js" type="text/javascript"></script>
</head>

<body>
  <script type="text/javascript" charset="utf-8">
  //Fox collection ID: 595d08b392ca9a000d0748df
  //variables defined
  var  resizer = {view: "resizer"} 
  var BaseURL = 'http://candygram.neurology.emory.edu:8080/api/v1/' //url to access the API in general
  var FoxFolders_URL = 'folder?parentType=collection&parentId=595d08b392ca9a000d0748df&limit=50&sort=lowerName&sortdir=1'
  var thumbHeight = 300; //height of thumbnail displayed
  var currentImageID = ''; //ID of the selected image (for getting metadata)
  var currentOCR = [];
  currentOCR['sampleOutput'] = ''; //the current OCR saved in the API
  var currentImageURL = ''; //
   
  // 
  function selectFolder(id) { //when folder is switched
    $$('wbx_richOCR').setValue(""); //blanks OCR output container
    $$('metaData').define("template",""); //blanks current metadata container
    $$('metaData').refresh();
    var row = this.getPopup().getBody().getItem(id);
    $$("wbx_MainGrid").clearAll();
    //don't load any files that don't have valid images
    $.getJSON(ListItemsInGirderFolder(row['_id']), function(json) {
      for(var i = 0; i < json.length; i++) {
        var obj = json[i];
        if(!obj.largeImage) {
          json.splice(i,1);
          i--;
        }
      }
      $$("wbx_MainGrid").parse( json );
    });
    // $$("wbx_MainGrid").load( ListItemsInGirderFolder(row['_id']));
    currentOCR['sampleOutput'] = '';
    currentImageURL = '';
    $("#labelImg").attr("src",'');
  };

  //returns the json objects for a selected image set (a date)
  function ListItemsInGirderFolder( folderID) {
    url = BaseURL + 'item?folderId=' + folderID + "&sort=lowerName&limit=50&sortdir=1";
    return url;
  }

  myHeader = {
    view: "template",
    type: "header",
    template: "Digital Slide Archive OCR Application",
  };
 
  wbx_FolderSelector = {
    view: "combo",
    css: "headerStyle",
    id: "wbx_FolderSelector",
    label: "Select Folder:",
    labelWidth: 101,

    on: { //allows attaching custom handlers to inner events of the component
      onChange: selectFolder, //fires when the value of the control is changed
    },
    options: {
      body: {
        template: "#name#", //this is the name of the top level fox folders (the date seen in combo box)
      }
    },
  }

  //loads the fox top level files
  webix.ready(function() {
    webix.ajax("http://127.0.0.1:5000/", function(response) {
        webix.message(response);
    });
    var list = $$("wbx_FolderSelector").getPopup().getList(); //connects to combo box
    list.clearAll();
    webix.ajax().get(BaseURL + FoxFolders_URL, function(data){
      var json = JSON.parse(data);
      list.parse(json);
      $$("wbx_FolderSelector").setValue(json[0].id);
    });
  });

  //source is changed depending on the selection on right container
  wbx_MyImageSet = {
    view: "template",
    id: "wbx_MyImageSet",
    borderless: true,
    template: "<img id='labelImg' src=''>"
  }

  // Let's list the folders for the FOX Collection
  //the sort command coupled with the id allows for formatting of the datatable based ont he svs file. This is how it is able to load the data properly
  FoxFolderViewColList = [
    { id: "imageThumb", template: function(obj) {
      imgString = "<img src='" +BaseURL + "item/" + obj['_id'] + "/tiles/thumbnail?height=80&encoding=JPEG' >"
      return imgString
      },
    }, 
    {id: "name", sort: "string"},
    {id: "size", sort: "int"},
    {id: "updated"},
    {id: "_id", sort: "string"}
  ]

  function runOCR(id) {
    if(currentImageURL.length > 0) {
      webix.ajax("http://127.0.0.1:5000/getImage?imageURL="+currentImageURL, function(response) {
        var data = JSON.parse(response);
        data['sampleOutput'] = removeSpecialChars(data['sampleOutput']);
        currentOCR = data;
        $$("wbx_richOCR").setValue(currentOCR['sampleOutput']);
      })
    } else {
      webix.message("Please select a file from the right first.");
    };
  };

  function removeSpecialChars(str) {
  return str.replace(/(?!\w|\/|\.|\s)./g, '')
    .replace(/\s+/g, ' ')
    .replace(/^(\s*)([\W\w]*)(\b\s*$)/g, '$2');
}

  function getMetadata(id) {
    webix.ajax("http://127.0.0.1:5000/getMetadata?imageID="+currentImageID, function(response) {
      var data = JSON.parse(response);
      if (data['bad_ocr_output'] != null) {
        output = data.bad_ocr_output;
      } else {
        output = "No current Metadata!";
      };
      $$('metaData').define("template",output);
      $$('metaData').refresh();
    });
  };

  function saveMetadata(id) {
    currentOCR['sampleOutput'] = $$("wbx_richOCR").getValue();
    console.log(currentOCR['sampleOutput']);
    currentOCR['sampleOutput'].replace(/ {2,}/g, '');
    console.log(currentOCR['sampleOutput']);

    if (currentOCR['sampleOutput'].length > 0) {
      webix.ajax("http://127.0.0.1:5000/updateMetadata?imageID="+currentImageID+"&ocr_output="+currentOCR['sampleOutput'], function(response) {
        webix.message(response);
      });
      getMetadata(id);
    } else {
      webix.message("Please select and image and run OCR before attempting to save!");
    };
  };

  save_button = {
    view:"button",
    id:"save_button",
    value:"Save OCR Output",
    borderless:true,
    type:"form",
    align:"center",
    click: saveMetadata
  }

  ocr_button = {
    view:"button", 
    id:"ocr_button", 
    value:"Run OCR", 
    type:"form", 
    align: "center",
    borderless: true,
    click: runOCR
  }

  metaData = {
    rows: [
      {view:"template", template:"Current Meta Data", type:"header"},
      {view:"template",
       id:"metaData",
       template: ""}
    ]
  }

  wbx_outputOCR = {
    rows: [ 
      {view:"template", id:"ocroutputHeader", template:"OCR Output", type:"header"},
      {
        view:"richtext", 
        id:"wbx_richOCR", 
        label:"OCR Output",
        labelPosition:"top",
        value:"", 
      }
    ]
  }

  output = {
    cols: [wbx_outputOCR, metaData]
  }

  wbx_buttons = {
    cols: [ocr_button, save_button] //metadata_button,
  }

  //the left panel (not including the header)
  wbx_LeftMainPanel = {
    rows: [ wbx_FolderSelector, wbx_MyImageSet, wbx_buttons, output]
  }

  wbx_MainGrid = {
    view:"datatable",
    id: "wbx_MainGrid",
    autoConfig: true,
    columns: FoxFolderViewColList,
    rowHeight: 100,
    select: "row",
    on: { //this will fire when selection is changed on datatable
      "onItemClick": function(id){
        currentOCR['sampleOutput'] = '';
        $$('wbx_richOCR').setValue(""); //clear ocr output when switching files
        DataForCurrentRow =   this.getItem(id);
        currentImageURL = BaseURL + "item/" + DataForCurrentRow._id + "/tiles/images/label?height=" + thumbHeight;
        $("#labelImg").attr("src",currentImageURL);
        currentImageID = DataForCurrentRow._id;
        getMetadata(id);
      }
    }
  }

  wbx_RightMainPanel = {
    rows: [ //contains another header
      {view:"template", type:"header",template: "DataGrid"},
      wbx_MainGrid
    ]
  }
  
  //main ui
  webix.ui({
    //This ui is a 2 rows (first is just the header) with the last row being split into 2 columns.
    rows: [
      myHeader, //the simple header, this is static
      {
        cols: [ wbx_LeftMainPanel, resizer, wbx_RightMainPanel ]
      },
    ]
  });
  </script>
</body>
</html>
